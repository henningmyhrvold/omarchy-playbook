---
# Claude Code Role - CLI-based MCP registration
# Registers MCP servers using 'claude mcp add' for project directories

# =============================================================================
# Package Installation
# =============================================================================
- name: Install Claude Code from Omarchy repository
  community.general.pacman:
    name: claude-code
    state: present
  become: true
  tags: ["claude-code", "packages"]

# =============================================================================
# Directory Setup
# =============================================================================
- name: Create project directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ claude_code_user }}"
    group: "{{ claude_code_user }}"
    mode: "0755"
  loop: "{{ claude_code_project_dirs }}"
  become: true
  become_user: "{{ claude_code_user }}"
  tags: ["claude-code", "folders"]

# =============================================================================
# Verify MCP Containers are Running
# =============================================================================
- name: Check if MCP containers are running
  ansible.builtin.shell: |
    docker ps --format '{{ '{{' }}.Names{{ '}}' }}' | grep '^mcp-' || true
  register: _running_mcp_containers
  changed_when: false
  tags: ["claude-code", "mcp"]

- name: Display running MCP containers
  ansible.builtin.debug:
    msg: "Running MCP containers: {{ _running_mcp_containers.stdout_lines }}"
  tags: ["claude-code", "mcp"]

# =============================================================================
# Remove Existing MCP Servers (to avoid duplicates)
# =============================================================================
- name: Remove existing MCP servers from project directories
  ansible.builtin.shell: |
    cd "{{ item }}"
    claude mcp remove filesystem 2>/dev/null || true
    claude mcp remove ref 2>/dev/null || true
    claude mcp remove docker 2>/dev/null || true
  loop: "{{ claude_code_project_dirs }}"
  become: true
  become_user: "{{ claude_code_user }}"
  changed_when: false
  failed_when: false
  tags: ["claude-code", "mcp"]

# =============================================================================
# Register Filesystem MCP Server
# =============================================================================
- name: Register filesystem MCP server for project directories
  ansible.builtin.shell: |
    cd "{{ item }}"
    claude mcp add {{ mcp_filesystem_name }} -- {{ mcp_filesystem_command }} {{ mcp_filesystem_args | join(' ') }}
  loop: "{{ claude_code_project_dirs }}"
  become: true
  become_user: "{{ claude_code_user }}"
  when:
    - mcp_filesystem_enabled | bool
    - "'mcp-filesystem' in _running_mcp_containers.stdout"
  register: _mcp_filesystem_add
  changed_when: "'Added' in _mcp_filesystem_add.stdout"
  tags: ["claude-code", "mcp"]

# =============================================================================
# Register Ref MCP Server
# =============================================================================
- name: Register ref MCP server for project directories
  ansible.builtin.shell: |
    cd "{{ item }}"
    claude mcp add {{ mcp_ref_name }} -- {{ mcp_ref_command }} {{ mcp_ref_args | join(' ') }}
  loop: "{{ claude_code_project_dirs }}"
  become: true
  become_user: "{{ claude_code_user }}"
  when:
    - mcp_ref_enabled | bool
    - "'mcp-ref' in _running_mcp_containers.stdout"
  register: _mcp_ref_add
  changed_when: "'Added' in _mcp_ref_add.stdout"
  tags: ["claude-code", "mcp"]

# =============================================================================
# Register Docker MCP Server
# =============================================================================
- name: Register docker MCP server for project directories
  ansible.builtin.shell: |
    cd "{{ item }}"
    claude mcp add {{ mcp_docker_name }} -- {{ mcp_docker_command }} {{ mcp_docker_args | join(' ') }}
  loop: "{{ claude_code_project_dirs }}"
  become: true
  become_user: "{{ claude_code_user }}"
  when:
    - mcp_docker_enabled | bool
    - "'mcp-docker' in _running_mcp_containers.stdout"
  register: _mcp_docker_add
  changed_when: "'Added' in _mcp_docker_add.stdout"
  tags: ["claude-code", "mcp"]

# =============================================================================
# Verify Registration
# =============================================================================
- name: Verify MCP servers are registered
  ansible.builtin.shell: |
    cd "{{ item }}"
    claude mcp list
  loop: "{{ claude_code_project_dirs }}"
  become: true
  become_user: "{{ claude_code_user }}"
  register: _mcp_list
  changed_when: false
  tags: ["claude-code", "verify"]

# =============================================================================
# Summary
# =============================================================================
- name: Display Claude Code MCP setup summary
  ansible.builtin.debug:
    msg: |
      Claude Code MCP Configuration Complete:

      Project Directories:
      {% for dir in claude_code_project_dirs %}
      • {{ dir }}
      {% endfor %}

      Registered MCP Servers:
      {% if mcp_filesystem_enabled %}
      • filesystem - File operations ({{ mcp_filesystem_args[5:] | join(', ') }})
      {% endif %}
      {% if mcp_ref_enabled %}
      • ref - Documentation search (Context7)
      {% endif %}
      {% if mcp_docker_enabled %}
      • docker - Docker container management
      {% endif %}

      Usage:
      1. Navigate to a project directory:
         cd ~/src/your-project

      2. Start Claude Code:
         claude

      3. Check MCP servers:
         /mcp

      Note: MCP servers are registered per-project in Claude Code.
      To add MCP to a new project directory, run from that directory:
        claude mcp add <name> -- <command> [args...]
  tags: ["claude-code"]
