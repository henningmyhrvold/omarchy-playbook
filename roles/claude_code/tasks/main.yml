---
# =============================================================================
# Package Installation
# =============================================================================
- name: Install Claude Code from Omarchy repository
  community.general.pacman:
    name: claude-code
    state: present
  become: true
  tags: ["claude-code", "packages"]

# =============================================================================
# Directory Setup
# =============================================================================
- name: Create Claude Code directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ claude_code_user }}"
    group: "{{ claude_code_user }}"
    mode: "0755"
  loop:
    - "{{ claude_code_home }}/.claude"
    - "{{ claude_code_home }}/.local/bin"
  become: true
  tags: ["claude-code", "folders"]

# =============================================================================
# Check Claude Code Installation
# =============================================================================
- name: Check if Claude Code CLI is installed
  ansible.builtin.command: which claude
  register: _claude_check
  changed_when: false
  failed_when: false
  tags: ["claude-code", "verify"]

- name: Display Claude Code installation status
  ansible.builtin.debug:
    msg: "✓ Claude Code is installed at {{ _claude_check.stdout }}"
  when: _claude_check.rc == 0
  tags: ["claude-code", "verify"]

# =============================================================================
# MCP Container Discovery
# =============================================================================
- name: Discover running MCP containers
  ansible.builtin.shell: |
    docker ps --format '{{ '{{' }}.Names{{ '}}' }}' | grep '^mcp-' || true
  register: _mcp_containers
  changed_when: false
  ignore_errors: true
  tags: ["claude-code", "config"]

# =============================================================================
# MCP Configuration
# =============================================================================
- name: Generate Claude Code configuration from running containers
  ansible.builtin.template:
    src: claude-config.json.j2
    dest: "{{ claude_code_home }}/.claude/claude.json"
    mode: '0600'
    owner: "{{ claude_code_user }}"
    group: "{{ claude_code_user }}"
  become: true
  when: _mcp_containers is defined
  tags: ["claude-code", "config"]

# =============================================================================
# Summary
# =============================================================================
- name: Display Claude Code setup summary
  ansible.builtin.debug:
    msg: |
      Claude Code Configuration:
      • Installed from: Omarchy repository
      • Config file: {{ claude_code_home }}/.claude/claude.json
      • Registered MCP servers: {{ (_mcp_containers.stdout_lines | default([])) | length }}

      Usage:
      1. Ensure MCP servers are running:
         systemctl --user status 'mcp-*'
      2. Start Claude Code:
         cd ~/src/your-project
         claude
      3. Check MCP status inside Claude:
         /mcp

      Manage MCP servers:
      systemctl --user status 'mcp-*'
      systemctl --user restart mcp-filesystem
      journalctl --user -u mcp-filesystem -f
  tags: ["claude-code"]
