---
# Claude Code Role - .mcp.json based configuration

# =============================================================================
# Package Installation
# =============================================================================
- name: Install Claude Code from Omarchy repository
  community.general.pacman:
    name: claude-code
    state: present
  become: true
  tags: ["claude-code", "packages"]

# =============================================================================
# Directory Setup
# =============================================================================
- name: Create MCP configuration directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ claude_code_user }}"
    group: "{{ claude_code_user }}"
    mode: "0755"
  loop: "{{ claude_code_mcp_json_locations }}"
  become: true
  become_user: "{{ claude_code_user }}"
  tags: ["claude-code", "folders"]

# =============================================================================
# Check Running MCP Containers
# =============================================================================
- name: Check for running MCP containers
  ansible.builtin.shell: docker ps --format '{{ '{{' }}.Names{{ '}}' }}' | grep '^mcp-' || true
  register: _running_containers
  changed_when: false
  tags: ["claude-code", "mcp"]

- name: Set fact for available MCP servers
  ansible.builtin.set_fact:
    _mcp_filesystem_available: "{{ 'mcp-filesystem' in _running_containers.stdout }}"
    _mcp_ref_available: "{{ 'mcp-ref' in _running_containers.stdout }}"
    _mcp_docker_available: "{{ 'mcp-docker' in _running_containers.stdout }}"
  tags: ["claude-code", "mcp"]

# =============================================================================
# Deploy .mcp.json Files
# =============================================================================
- name: Deploy .mcp.json configuration files
  ansible.builtin.template:
    src: mcp.json.j2
    dest: "{{ item }}/.mcp.json"
    owner: "{{ claude_code_user }}"
    group: "{{ claude_code_user }}"
    mode: "0644"
  loop: "{{ claude_code_mcp_json_locations }}"
  become: true
  become_user: "{{ claude_code_user }}"
  tags: ["claude-code", "config"]

# =============================================================================
# CLI Registration (Backward Compatibility)
# =============================================================================
- name: Remove existing MCP CLI registrations
  ansible.builtin.shell: |
    cd "{{ item }}"
    claude mcp remove filesystem 2>/dev/null || true
    claude mcp remove ref 2>/dev/null || true
    claude mcp remove docker 2>/dev/null || true
  loop: "{{ claude_code_cli_registration_dirs }}"
  become: true
  become_user: "{{ claude_code_user }}"
  changed_when: false
  failed_when: false
  tags: ["claude-code", "cli"]

- name: Register filesystem MCP via CLI
  ansible.builtin.shell: |
    cd "{{ item }}"
    claude mcp add filesystem -- docker exec -i mcp-filesystem npx @modelcontextprotocol/server-filesystem {{ claude_code_home }}/src {{ claude_code_home }}/projects {{ claude_code_home }}/Documents
  loop: "{{ claude_code_cli_registration_dirs }}"
  become: true
  become_user: "{{ claude_code_user }}"
  when:
    - mcp_filesystem_enabled | bool
    - _mcp_filesystem_available | bool
  register: _cli_fs
  changed_when: "'Added' in _cli_fs.stdout"
  failed_when: false
  tags: ["claude-code", "cli"]

- name: Register ref MCP via CLI
  ansible.builtin.shell: |
    cd "{{ item }}"
    claude mcp add ref -- docker exec -i mcp-ref npx @upstash/context7-mcp
  loop: "{{ claude_code_cli_registration_dirs }}"
  become: true
  become_user: "{{ claude_code_user }}"
  when:
    - mcp_ref_enabled | bool
    - _mcp_ref_available | bool
  register: _cli_ref
  changed_when: "'Added' in _cli_ref.stdout"
  failed_when: false
  tags: ["claude-code", "cli"]

- name: Register docker MCP via CLI
  ansible.builtin.shell: |
    cd "{{ item }}"
    claude mcp add docker -- docker exec -i mcp-docker mcp-server-docker
  loop: "{{ claude_code_cli_registration_dirs }}"
  become: true
  become_user: "{{ claude_code_user }}"
  when:
    - mcp_docker_enabled | bool
    - _mcp_docker_available | bool
  register: _cli_docker
  changed_when: "'Added' in _cli_docker.stdout"
  failed_when: false
  tags: ["claude-code", "cli"]

# =============================================================================
# Summary
# =============================================================================
- name: Display setup summary
  ansible.builtin.debug:
    msg: |
      Claude Code MCP Configuration:

      .mcp.json files created in:
      {% for loc in claude_code_mcp_json_locations %}
      • {{ loc }}/.mcp.json
      {% endfor %}

      Available MCP servers:
      {% if _mcp_filesystem_available and mcp_filesystem_enabled %}
      • filesystem - File operations
      {% endif %}
      {% if _mcp_ref_available and mcp_ref_enabled %}
      • ref - Documentation search (Context7)
      {% endif %}
      {% if _mcp_docker_available and mcp_docker_enabled %}
      • docker - Docker container management
      {% endif %}

      How .mcp.json works:
      • Any project under ~/src will find ~/src/.mcp.json
      • Any project under ~/projects will find ~/projects/.mcp.json
      • All projects will fall back to ~/.mcp.json

      First-time usage:
      1. cd ~/src/your-project
      2. claude
      3. Approve .mcp.json when prompted
      4. /mcp to verify

      The approval is remembered per-project after first approval.
  tags: ["claude-code"]
