---
# AUR Packages Role - Install packages from aur_installed_packages list
# Uses kewlfft.aur collection with yay (Omarchy's AUR helper)

- name: Allow target user to run pacman without password (for AUR)
  ansible.builtin.lineinfile:
    path: /etc/sudoers.d/aur-temp
    line: "{{ ansible_user_id }} ALL=(ALL) NOPASSWD: /usr/bin/pacman *"
    create: true
    mode: "0440"
    validate: /usr/sbin/visudo -cf %s
  become: true
  tags: ["aur-packages"]

- name: Install AUR packages
  kewlfft.aur.aur:
    name: "{{ item }}"
    use: yay
    state: present
  loop: "{{ aur_installed_packages }}"
  become: true
  become_user: "{{ ansible_user_id }}"
  when: aur_installed_packages is defined and aur_installed_packages | length > 0
  tags: ["aur-packages"]

- name: Remove temporary sudoers rule
  ansible.builtin.file:
    path: /etc/sudoers.d/aur-temp
    state: absent
  become: true
  tags: ["aur-packages"]
