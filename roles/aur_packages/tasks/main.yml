---
# AUR Packages Role - Installs AUR packages from config.yml using yay
- name: Backup original sudoers file for pacman configuration
  ansible.builtin.copy:
    src: /etc/sudoers
    dest: /etc/sudoers.pacman_backup
    owner: root
    mode: "0644"
    remote_src: true
  become: true
  tags: ['aur-packages']

- name: Allow target user to run pacman without password
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    line: '{{ target_user }} ALL=(ALL) NOPASSWD: /usr/bin/pacman'
    validate: /usr/sbin/visudo -cf %s
  become: true
  tags: ['aur-packages']

- name: Install packages from aur_installed_packages list
  kewlfft.aur.aur:
    name: "{{ item }}"
    use: yay
    state: present
  loop: "{{ aur_installed_packages }}"
  become: true
  become_user: "{{ target_user }}"
  when: aur_installed_packages is defined
  tags: ['aur-packages']

- name: Revert sudoers after pacman configuration
  ansible.builtin.copy:
    src: /etc/sudoers.pacman_backup
    dest: /etc/sudoers
    owner: root
    mode: "0644"
    remote_src: true
    validate: /usr/sbin/visudo -cf %s
  become: true
  tags: ['aur-packages']
